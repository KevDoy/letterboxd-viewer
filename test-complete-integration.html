<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete RSS Integration Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <style>
        .test-section { 
            border: 1px solid #dee2e6; 
            border-radius: 0.375rem; 
            padding: 1rem; 
            margin: 1rem 0; 
        }
        .star-rating { color: #ffc107; }
        .status-pass { color: #198754; }
        .status-fail { color: #dc3545; }
        .status-warning { color: #fd7e14; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">Complete RSS Integration Test</h1>
        
        <div class="test-section">
            <h3>1. RSS Manager Functionality</h3>
            <div id="rss-test-results"></div>
        </div>
        
        <div class="test-section">
            <h3>2. Star Rating Extraction & Display</h3>
            <div id="star-test-results"></div>
        </div>
        
        <div class="test-section">
            <h3>3. Data Merging & Integration</h3>
            <div id="merge-test-results"></div>
        </div>
        
        <div class="test-section">
            <h3>4. Live Data Toggle</h3>
            <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" id="testLiveDataSwitch">
                <label class="form-check-label" for="testLiveDataSwitch">
                    <i class="bi bi-rss"></i> Test Live Data Toggle
                </label>
            </div>
            <div id="toggle-test-results"></div>
        </div>
        
        <div class="test-section">
            <h3>5. Overall Status</h3>
            <div id="overall-status"></div>
        </div>
    </div>

    <script src="rss-manager.js"></script>
    <script src="app.js"></script>
    <script>
        class IntegrationTester {
            constructor() {
                this.testResults = {
                    rssManager: false,
                    starRating: false,
                    dataMerging: false,
                    liveToggle: false
                };
            }

            async runAllTests() {
                await this.testRSSManager();
                await this.testStarRating();
                await this.testDataMerging();
                this.setupToggleTest();
                this.updateOverallStatus();
            }

            async testRSSManager() {
                const resultsDiv = document.getElementById('rss-test-results');
                resultsDiv.innerHTML = '<p>Testing RSS Manager...</p>';

                try {
                    // Initialize RSS manager
                    window.letterboxdRSS = new LetterboxdRSSManager();
                    resultsDiv.innerHTML += '<p class="status-pass">‚úÖ RSS Manager created</p>';

                    // Test initialization
                    const result = window.letterboxdRSS.init('filmcritic', true);
                    resultsDiv.innerHTML += `<p class="status-pass">‚úÖ RSS Manager initialized: ${result}</p>`;

                    // Test availability check
                    const isAvailable = window.letterboxdRSS.isLiveDataAvailable();
                    resultsDiv.innerHTML += `<p class="status-pass">‚úÖ Live data available: ${isAvailable}</p>`;

                    // Test RSS access
                    const hasAccess = await window.letterboxdRSS.testRSSAccess('filmcritic');
                    resultsDiv.innerHTML += `<p class="${hasAccess ? 'status-pass' : 'status-warning'}">
                        ${hasAccess ? '‚úÖ' : '‚ö†Ô∏è'} RSS Access: ${hasAccess}
                    </p>`;

                    this.testResults.rssManager = true;

                } catch (error) {
                    resultsDiv.innerHTML += `<p class="status-fail">‚ùå RSS Manager Error: ${error.message}</p>`;
                    console.error('RSS Manager test failed:', error);
                }
            }

            async testStarRating() {
                const resultsDiv = document.getElementById('star-test-results');
                resultsDiv.innerHTML = '<p>Testing star rating extraction...</p>';

                try {
                    const rssManager = window.letterboxdRSS;
                    
                    // Test star extraction
                    const testCases = [
                        { title: 'filmcritic watched The Matrix ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ', expected: 5 },
                        { title: 'filmcritic watched Inception ‚òÖ‚òÖ‚òÖ‚òÖ', expected: 4 },
                        { title: 'filmcritic watched Bad Movie ‚òÖ', expected: 1 },
                        { title: 'filmcritic watched Unrated Film', expected: null }
                    ];

                    for (const testCase of testCases) {
                        const filmInfo = rssManager.extractFilmInfo(testCase.title, '', '');
                        const passed = filmInfo.rating === testCase.expected;
                        resultsDiv.innerHTML += `
                            <p class="${passed ? 'status-pass' : 'status-fail'}">
                                ${passed ? '‚úÖ' : '‚ùå'} "${testCase.title}" ‚Üí ${filmInfo.rating} stars
                                ${filmInfo.rating ? `<span class="star-rating">${'‚òÖ'.repeat(filmInfo.rating)}</span>` : '(no rating)'}
                            </p>
                        `;
                    }

                    this.testResults.starRating = true;

                } catch (error) {
                    resultsDiv.innerHTML += `<p class="status-fail">‚ùå Star Rating Error: ${error.message}</p>`;
                    console.error('Star rating test failed:', error);
                }
            }

            async testDataMerging() {
                const resultsDiv = document.getElementById('merge-test-results');
                resultsDiv.innerHTML = '<p>Testing data merging...</p>';

                try {
                    const rssManager = window.letterboxdRSS;
                    
                    // Test CSV data structure compatibility
                    const sampleCSVEntry = {
                        Name: "The Matrix",
                        Year: "1999",
                        "Letterboxd URI": "https://letterboxd.com/film/the-matrix/",
                        "Watched Date": "2024-01-15",
                        Rating: "5"
                    };

                    // Test RSS data conversion
                    const mockRSSItem = {
                        activityType: 'diary',
                        filmInfo: {
                            title: "Inception",
                            year: 2010,
                            rating: 4,
                            letterboxdUrl: "https://letterboxd.com/film/inception/"
                        },
                        pubDate: new Date('2024-02-01')
                    };

                    // Test conversion to CSV format
                    const rssDate = new Date('2024-02-01');
                    const convertedEntry = rssManager.convertRSSItemToCSVFormat(mockRSSItem.filmInfo, rssDate);
                    
                    resultsDiv.innerHTML += '<p class="status-pass">‚úÖ RSS to CSV conversion successful</p>';
                    resultsDiv.innerHTML += `
                        <div class="mt-2 p-2 bg-light rounded">
                            <strong>Converted Entry:</strong><br>
                            Name: ${convertedEntry.Name}<br>
                            Year: ${convertedEntry.Year}<br>
                            Rating: ${convertedEntry.Rating} <span class="star-rating">${'‚òÖ'.repeat(parseInt(convertedEntry.Rating))}</span><br>
                            Watched Date: ${convertedEntry['Watched Date']}<br>
                            Is Live Data: ${convertedEntry.isLiveData}
                        </div>
                    `;

                    // Test field compatibility
                    const requiredFields = ['Name', 'Year', 'Letterboxd URI', 'Watched Date', 'Rating'];
                    const hasAllFields = requiredFields.every(field => convertedEntry.hasOwnProperty(field));
                    
                    resultsDiv.innerHTML += `<p class="${hasAllFields ? 'status-pass' : 'status-fail'}">
                        ${hasAllFields ? '‚úÖ' : '‚ùå'} Field compatibility check: ${hasAllFields}
                    </p>`;

                    this.testResults.dataMerging = hasAllFields;

                } catch (error) {
                    resultsDiv.innerHTML += `<p class="status-fail">‚ùå Data Merging Error: ${error.message}</p>`;
                    console.error('Data merging test failed:', error);
                }
            }

            setupToggleTest() {
                const resultsDiv = document.getElementById('toggle-test-results');
                const toggle = document.getElementById('testLiveDataSwitch');

                resultsDiv.innerHTML = '<p>Click the toggle above to test live data functionality.</p>';

                toggle.addEventListener('change', async () => {
                    resultsDiv.innerHTML += `<p>üîÑ Toggle switched to: ${toggle.checked}</p>`;

                    try {
                        // Simulate the app's toggle functionality
                        if (toggle.checked) {
                            resultsDiv.innerHTML += '<p>üì° Testing RSS connectivity...</p>';
                            const hasAccess = await window.letterboxdRSS.testRSSAccess('filmcritic');
                            
                            if (hasAccess) {
                                resultsDiv.innerHTML += '<p class="status-pass">‚úÖ RSS connected successfully</p>';
                                resultsDiv.innerHTML += '<p class="status-pass">‚úÖ Live data would be enabled</p>';
                                this.testResults.liveToggle = true;
                            } else {
                                resultsDiv.innerHTML += '<p class="status-warning">‚ö†Ô∏è RSS connection failed</p>';
                                toggle.checked = false;
                            }
                        } else {
                            resultsDiv.innerHTML += '<p class="status-pass">‚úÖ Live data disabled</p>';
                        }

                        this.updateOverallStatus();

                    } catch (error) {
                        resultsDiv.innerHTML += `<p class="status-fail">‚ùå Toggle Error: ${error.message}</p>`;
                        toggle.checked = false;
                    }
                });
            }

            updateOverallStatus() {
                const statusDiv = document.getElementById('overall-status');
                const passCount = Object.values(this.testResults).filter(Boolean).length;
                const totalTests = Object.keys(this.testResults).length;

                const statusClass = passCount === totalTests ? 'status-pass' : 
                                   passCount > totalTests / 2 ? 'status-warning' : 'status-fail';

                statusDiv.innerHTML = `
                    <h4 class="${statusClass}">
                        ${passCount === totalTests ? 'üéâ' : passCount > 0 ? '‚ö†Ô∏è' : '‚ùå'} 
                        Integration Status: ${passCount}/${totalTests} tests passed
                    </h4>
                    <ul>
                        <li class="${this.testResults.rssManager ? 'status-pass' : 'status-fail'}">
                            RSS Manager: ${this.testResults.rssManager ? 'PASS' : 'FAIL'}
                        </li>
                        <li class="${this.testResults.starRating ? 'status-pass' : 'status-fail'}">
                            Star Rating: ${this.testResults.starRating ? 'PASS' : 'FAIL'}
                        </li>
                        <li class="${this.testResults.dataMerging ? 'status-pass' : 'status-fail'}">
                            Data Merging: ${this.testResults.dataMerging ? 'PASS' : 'FAIL'}
                        </li>
                        <li class="${this.testResults.liveToggle ? 'status-pass' : 'status-fail'}">
                            Live Toggle: ${this.testResults.liveToggle ? 'PASS' : 'PENDING'}
                        </li>
                    </ul>
                `;

                if (passCount === totalTests - 1) { // All except toggle (which requires user interaction)
                    statusDiv.innerHTML += `
                        <div class="alert alert-success mt-3">
                            <strong>üéØ Ready for Production!</strong><br>
                            The RSS live data integration is complete and working properly. 
                            Click the live data toggle above to complete the final test.
                        </div>
                    `;
                }
            }
        }

        // Run tests when page loads
        document.addEventListener('DOMContentLoaded', () => {
            const tester = new IntegrationTester();
            tester.runAllTests();
        });
    </script>
</body>
</html>
