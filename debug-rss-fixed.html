<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSS Debug with Base64 Fix</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            padding: 20px; 
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-input {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        input[type="text"] {
            padding: 8px 12px;
            margin: 0 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 200px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover { background: #0056b3; }
        .debug-info { 
            margin: 5px 0; 
            padding: 8px 12px; 
            border-left: 4px solid #007bff;
            background: #f8f9fa;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        .success { 
            border-left-color: #28a745; 
            background: #d4edda; 
            color: #155724;
        }
        .error { 
            border-left-color: #dc3545; 
            background: #f8d7da; 
            color: #721c24;
        }
        .warning {
            border-left-color: #ffc107;
            background: #fff3cd;
            color: #856404;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            margin: 10px 0;
            font-size: 12px;
        }
        .step-header {
            font-weight: bold;
            color: #495057;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>RSS Debug with Base64 Decoding Fix</h1>
        
        <div class="test-input">
            <label for="username">Letterboxd Username:</label>
            <input type="text" id="username" value="kevdoy" placeholder="Enter username">
            <button onclick="debugRSS()">Debug RSS</button>
            <button onclick="clearResults()">Clear</button>
            <button onclick="testMultipleUsers()">Test Multiple Users</button>
        </div>

        <div id="results"></div>
    </div>

    <script src="rss-manager.js"></script>
    <script>
        function addDebugInfo(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `debug-info ${type}`;
            div.innerHTML = message;
            resultsDiv.appendChild(div);
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        async function debugRSS() {
            const username = document.getElementById('username').value || 'kevdoy';
            clearResults();
            
            addDebugInfo('üîç Starting comprehensive RSS debug analysis...', 'step-header');
            addDebugInfo(`Target username: ${username}`);

            try {
                // Step 1: Test basic fetch
                addDebugInfo('üì° Step 1: Testing CORS proxy and RSS endpoint...', 'step-header');
                const rssUrl = `https://letterboxd.com/${username}/rss/`;
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(rssUrl)}`;
                
                addDebugInfo(`RSS URL: ${rssUrl}`);
                addDebugInfo(`Proxy URL: ${proxyUrl.substring(0, 100)}...`);
                
                const response = await fetch(proxyUrl);
                addDebugInfo(`Response status: ${response.status} ${response.statusText}`, 
                    response.ok ? 'success' : 'error');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                if (!data.contents) {
                    throw new Error('No contents in response');
                }

                // Step 2: Analyze raw content
                addDebugInfo('üî¨ Step 2: Analyzing raw response content...', 'step-header');
                let rssContent = data.contents;
                addDebugInfo(`Raw content length: ${rssContent.length}`);
                addDebugInfo(`Content type: ${typeof rssContent}`);
                
                const contentPreview = rssContent.substring(0, 150);
                addDebugInfo(`Content preview: ${contentPreview}...`);
                
                // Step 3: Base64 detection and decoding
                addDebugInfo('üîì Step 3: Base64 detection and decoding...', 'step-header');
                if (rssContent.startsWith('data:application/rss+xml;charset=utf-8;base64,')) {
                    addDebugInfo('‚úÖ Detected base64 encoded data URL!', 'success');
                    addDebugInfo('üîß Extracting and decoding base64 content...');
                    
                    const base64Content = rssContent.split(',')[1];
                    addDebugInfo(`Base64 string length: ${base64Content.length}`);
                    
                    try {
                        rssContent = atob(base64Content);
                        addDebugInfo(`‚úÖ Successfully decoded! New length: ${rssContent.length}`, 'success');
                        addDebugInfo(`Decoded preview: ${rssContent.substring(0, 150)}...`);
                    } catch (decodeError) {
                        addDebugInfo(`‚ùå Base64 decoding failed: ${decodeError.message}`, 'error');
                        throw decodeError;
                    }
                } else if (rssContent.startsWith('<?xml') || rssContent.startsWith('<rss')) {
                    addDebugInfo('‚úÖ Content is already plain XML (not base64)', 'success');
                } else {
                    addDebugInfo('‚ö†Ô∏è Unknown content format - attempting to parse anyway', 'warning');
                }

                // Step 4: XML parsing
                addDebugInfo('üìã Step 4: XML parsing and validation...', 'step-header');
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(rssContent, 'text/xml');
                
                const parseError = xmlDoc.querySelector('parsererror');
                if (parseError) {
                    addDebugInfo(`‚ùå XML parsing failed: ${parseError.textContent}`, 'error');
                    throw new Error(`XML parsing failed: ${parseError.textContent}`);
                }
                
                addDebugInfo('‚úÖ XML parsed successfully!', 'success');

                // Step 5: RSS structure analysis
                addDebugInfo('üìä Step 5: RSS structure analysis...', 'step-header');
                const channel = xmlDoc.querySelector('channel');
                const rssTitle = channel?.querySelector('title')?.textContent || 'No title';
                const rssDescription = channel?.querySelector('description')?.textContent || 'No description';
                
                addDebugInfo(`RSS Title: ${rssTitle}`);
                addDebugInfo(`RSS Description: ${rssDescription}`);

                const items = Array.from(xmlDoc.querySelectorAll('item'));
                addDebugInfo(`‚úÖ Found ${items.length} RSS items`, items.length > 0 ? 'success' : 'warning');

                // Step 6: Item analysis
                if (items.length > 0) {
                    addDebugInfo('üé¨ Step 6: Analyzing RSS items...', 'step-header');
                    
                    for (let i = 0; i < Math.min(3, items.length); i++) {
                        const item = items[i];
                        const title = item.querySelector('title')?.textContent || 'No title';
                        const link = item.querySelector('link')?.textContent || 'No link';
                        const pubDate = item.querySelector('pubDate')?.textContent || 'No date';
                        const description = item.querySelector('description')?.textContent || 'No description';
                        
                        addDebugInfo(`--- Item ${i + 1} ---`);
                        addDebugInfo(`Title: ${title}`);
                        addDebugInfo(`Link: ${link}`);
                        addDebugInfo(`Date: ${pubDate}`);
                        addDebugInfo(`Description: ${description.substring(0, 100)}...`);
                    }
                }

                // Step 7: RSS Manager integration test
                addDebugInfo('‚öôÔ∏è Step 7: Testing RSS Manager integration...', 'step-header');
                if (window.letterboxdRSS) {
                    const rssManager = window.letterboxdRSS;
                    addDebugInfo('‚úÖ RSS Manager available', 'success');
                    
                    // Clear cache to force fresh fetch
                    rssManager.clearCache();
                    rssManager.init(username, true);
                    
                    addDebugInfo(`RSS Manager initialized for user: ${username}`);
                    addDebugInfo(`Live data available: ${rssManager.isLiveDataAvailable()}`);
                    
                    try {
                        const rssItems = await rssManager.fetchRSSFeed();
                        addDebugInfo(`‚úÖ RSS Manager returned ${rssItems.length} processed items`, 'success');
                        
                        if (rssItems.length > 0) {
                            addDebugInfo('Sample processed item:');
                            const sampleItem = rssItems[0];
                            addDebugInfo(`<pre>${JSON.stringify(sampleItem, null, 2)}</pre>`);
                        }
                        
                        // Test diary entries
                        const diaryEntries = await rssManager.getRecentDiaryEntries(3);
                        addDebugInfo(`‚úÖ Diary entries: ${diaryEntries.length}`, 'success');
                        
                        // Test activity summary
                        const summary = await rssManager.getActivitySummary();
                        addDebugInfo(`‚úÖ Activity summary generated: ${summary ? 'Yes' : 'No'}`, 'success');
                        
                    } catch (managerError) {
                        addDebugInfo(`‚ùå RSS Manager error: ${managerError.message}`, 'error');
                    }
                } else {
                    addDebugInfo('‚ùå RSS Manager not available - check rss-manager.js loading', 'error');
                }

                addDebugInfo('üéâ RSS DEBUG COMPLETE - ALL TESTS PASSED!', 'success');

            } catch (error) {
                addDebugInfo(`üí• RSS DEBUG FAILED: ${error.message}`, 'error');
                addDebugInfo(`Stack trace: ${error.stack}`, 'error');
            }
        }

        async function testMultipleUsers() {
            const users = ['kevdoy', 'letterboxd', 'jaredgilman', 'brucewayne'];
            clearResults();
            
            addDebugInfo('üß™ Testing multiple users for RSS availability...', 'step-header');
            
            for (const user of users) {
                addDebugInfo(`Testing user: ${user}...`);
                try {
                    const rssUrl = `https://letterboxd.com/${user}/rss/`;
                    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(rssUrl)}`;
                    
                    const response = await fetch(proxyUrl);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.contents) {
                            let content = data.contents;
                            
                            // Handle base64 decoding
                            if (content.startsWith('data:application/rss+xml;charset=utf-8;base64,')) {
                                content = atob(content.split(',')[1]);
                            }
                            
                            const parser = new DOMParser();
                            const xmlDoc = parser.parseFromString(content, 'text/xml');
                            const items = xmlDoc.querySelectorAll('item');
                            
                            addDebugInfo(`‚úÖ ${user}: ${items.length} items`, 'success');
                        } else {
                            addDebugInfo(`‚ö†Ô∏è ${user}: No content`, 'warning');
                        }
                    } else {
                        addDebugInfo(`‚ùå ${user}: HTTP ${response.status}`, 'error');
                    }
                } catch (error) {
                    addDebugInfo(`‚ùå ${user}: ${error.message}`, 'error');
                }
            }
        }

        // Auto-run test on page load for convenience
        window.addEventListener('load', () => {
            addDebugInfo('üìÑ RSS Debug page loaded. Ready for testing!', 'success');
            addDebugInfo('üí° Click "Debug RSS" to start comprehensive testing.');
        });
    </script>
</body>
</html>
