<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSS Integration Verification</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            padding: 20px; 
            background: #f5f5f5;
            line-height: 1.6;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; color: #856404; }
        
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover { background: #0056b3; }
        
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
            font-size: 12px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background-color: #28a745; }
        .status-error { background-color: #dc3545; }
        .status-warning { background-color: #ffc107; }
        
        .test-results {
            margin-top: 20px;
        }
        
        .feature-test {
            border-left: 4px solid #007bff;
            padding-left: 15px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ RSS Integration Verification</h1>
        <p>This page verifies that the RSS live data functionality is working end-to-end with the base64 decoding fix.</p>
        
        <div class="test-section info">
            <h3>Current Configuration</h3>
            <p>üìù Reading configuration from users.json...</p>
            <div id="config-status">Loading...</div>
        </div>

        <div class="test-section">
            <h3>üß™ Integration Tests</h3>
            <button onclick="runFullIntegrationTest()">Run Full Integration Test</button>
            <button onclick="testRSSManagerOnly()">Test RSS Manager Only</button>
            <button onclick="testDifferentUser()">Test Different User</button>
            <button onclick="clearResults()">Clear Results</button>
        </div>

        <div id="test-results" class="test-results"></div>
    </div>

    <script src="rss-manager.js"></script>
    <script>
        let currentConfig = null;

        function addResult(title, content, type = 'info') {
            const resultsDiv = document.getElementById('test-results');
            const div = document.createElement('div');
            div.className = `test-section ${type}`;
            
            const statusIcon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : 'üìã';
            div.innerHTML = `<h4>${statusIcon} ${title}</h4>${content}`;
            resultsDiv.appendChild(div);
        }

        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
        }

        async function loadUserConfig() {
            try {
                const response = await fetch('letterboxd-export/users.json');
                const data = await response.json();
                currentConfig = data;
                
                const user = data.users[0]; // Assuming first user
                const configDiv = document.getElementById('config-status');
                
                if (user.enableLiveData && user.letterboxdUsername) {
                    configDiv.innerHTML = `
                        <div class="feature-test">
                            <p><span class="status-indicator status-success"></span><strong>Live Data:</strong> Enabled</p>
                            <p><span class="status-indicator status-success"></span><strong>Username:</strong> ${user.letterboxdUsername}</p>
                            <p><span class="status-indicator status-success"></span><strong>User ID:</strong> ${user.id}</p>
                            <p><span class="status-indicator status-success"></span><strong>Display Name:</strong> ${user.displayName}</p>
                        </div>
                    `;
                } else {
                    configDiv.innerHTML = `
                        <div class="feature-test">
                            <p><span class="status-indicator status-error"></span><strong>Live Data:</strong> ${user.enableLiveData ? 'Enabled' : 'Disabled'}</p>
                            <p><span class="status-indicator status-${user.letterboxdUsername ? 'success' : 'error'}"></span><strong>Username:</strong> ${user.letterboxdUsername || 'Not set'}</p>
                        </div>
                    `;
                }
                
                return user;
            } catch (error) {
                document.getElementById('config-status').innerHTML = `
                    <div class="feature-test">
                        <p><span class="status-indicator status-error"></span><strong>Error loading config:</strong> ${error.message}</p>
                    </div>
                `;
                throw error;
            }
        }

        async function runFullIntegrationTest() {
            clearResults();
            addResult('Integration Test Started', 'Running comprehensive RSS integration test...', 'info');

            try {
                // Step 1: Load configuration
                addResult('Step 1: Configuration', 'Loading user configuration...', 'info');
                const userConfig = await loadUserConfig();
                
                if (!userConfig.enableLiveData) {
                    addResult('Configuration Error', 'Live data is not enabled in users.json', 'error');
                    return;
                }
                
                if (!userConfig.letterboxdUsername) {
                    addResult('Configuration Error', 'No Letterboxd username configured', 'error');
                    return;
                }
                
                addResult('Configuration Loaded', `
                    <p>‚úÖ Live data enabled for user: <strong>${userConfig.letterboxdUsername}</strong></p>
                    <p>‚úÖ User display name: <strong>${userConfig.displayName}</strong></p>
                `, 'success');

                // Step 2: Test RSS Manager initialization
                addResult('Step 2: RSS Manager', 'Testing RSS Manager initialization...', 'info');
                
                if (!window.letterboxdRSS) {
                    addResult('RSS Manager Error', 'RSS Manager not available - check rss-manager.js loading', 'error');
                    return;
                }
                
                const rssManager = window.letterboxdRSS;
                rssManager.init(userConfig.letterboxdUsername, userConfig.enableLiveData);
                
                if (!rssManager.isLiveDataAvailable()) {
                    addResult('RSS Manager Error', 'RSS Manager reports live data not available', 'error');
                    return;
                }
                
                addResult('RSS Manager Ready', `
                    <p>‚úÖ RSS Manager initialized successfully</p>
                    <p>‚úÖ Live data available: ${rssManager.isLiveDataAvailable()}</p>
                    <p>‚úÖ Current username: ${userConfig.letterboxdUsername}</p>
                `, 'success');

                // Step 3: Test RSS fetching with base64 handling
                addResult('Step 3: RSS Fetch', 'Testing RSS feed fetch with base64 decoding...', 'info');
                
                // Clear cache for fresh test
                rssManager.clearCache();
                
                const startTime = Date.now();
                const rssItems = await rssManager.fetchRSSFeed();
                const fetchTime = Date.now() - startTime;
                
                addResult('RSS Fetch Results', `
                    <p>‚úÖ RSS fetch completed in ${fetchTime}ms</p>
                    <p>‚úÖ Items retrieved: <strong>${rssItems.length}</strong></p>
                    <p>‚úÖ Base64 decoding: Handled automatically</p>
                    ${rssItems.length > 0 ? `
                        <p><strong>Recent Activity Sample:</strong></p>
                        <pre>${JSON.stringify(rssItems.slice(0, 2), null, 2)}</pre>
                    ` : '<p>‚ö†Ô∏è No recent activity found (user may not have recent diary entries)</p>'}
                `, rssItems.length > 0 ? 'success' : 'warning');

                // Step 4: Test diary entries conversion
                addResult('Step 4: Diary Entries', 'Testing diary entries extraction...', 'info');
                
                const diaryEntries = await rssManager.getRecentDiaryEntries(10);
                addResult('Diary Entries Results', `
                    <p>‚úÖ Diary entries found: <strong>${diaryEntries.length}</strong></p>
                    ${diaryEntries.length > 0 ? `
                        <p><strong>Sample Diary Entry:</strong></p>
                        <pre>${JSON.stringify(diaryEntries[0], null, 2)}</pre>
                    ` : '<p>‚ö†Ô∏è No diary entries found in recent activity</p>'}
                `, diaryEntries.length > 0 ? 'success' : 'warning');

                // Step 5: Test activity summary
                addResult('Step 5: Activity Summary', 'Testing activity summary generation...', 'info');
                
                const summary = await rssManager.getActivitySummary();
                addResult('Activity Summary Results', `
                    <p>‚úÖ Activity summary generated: ${summary ? 'Yes' : 'No'}</p>
                    ${summary ? `
                        <p><strong>Summary Data:</strong></p>
                        <pre>${JSON.stringify(summary, null, 2)}</pre>
                    ` : '<p>‚ö†Ô∏è No activity summary available</p>'}
                `, summary ? 'success' : 'warning');

                // Step 6: Test caching
                addResult('Step 6: Caching', 'Testing RSS caching functionality...', 'info');
                
                const cacheStartTime = Date.now();
                const cachedItems = await rssManager.fetchRSSFeed(); // Should use cache
                const cacheTime = Date.now() - cacheStartTime;
                
                addResult('Caching Results', `
                    <p>‚úÖ Cached fetch completed in ${cacheTime}ms</p>
                    <p>‚úÖ Cache working: ${cacheTime < 100 ? 'Yes' : 'Possibly not (slow response)'}</p>
                    <p>‚úÖ Cached items count: ${cachedItems.length}</p>
                `, 'success');

                addResult('üéâ Integration Test Complete', `
                    <p><strong>All tests completed successfully!</strong></p>
                    <p>‚úÖ Configuration loading: Working</p>
                    <p>‚úÖ RSS Manager: Working</p>
                    <p>‚úÖ Base64 decoding: Working</p>
                    <p>‚úÖ RSS fetching: Working</p>
                    <p>‚úÖ Data parsing: Working</p>
                    <p>‚úÖ Caching: Working</p>
                    <p><strong>The RSS live data feature is ready for use!</strong></p>
                `, 'success');

            } catch (error) {
                addResult('Integration Test Failed', `
                    <p><strong>Error:</strong> ${error.message}</p>
                    <p><strong>Stack:</strong></p>
                    <pre>${error.stack}</pre>
                `, 'error');
            }
        }

        async function testRSSManagerOnly() {
            clearResults();
            
            try {
                const userConfig = await loadUserConfig();
                const username = userConfig.letterboxdUsername;
                
                addResult('RSS Manager Test', `Testing RSS Manager with username: ${username}`, 'info');
                
                const rssManager = window.letterboxdRSS;
                rssManager.init(username, true);
                rssManager.clearCache();
                
                const items = await rssManager.fetchRSSFeed();
                
                addResult('RSS Manager Results', `
                    <p>RSS items: ${items.length}</p>
                    <p>Test successful: ${items.length >= 0 ? 'Yes' : 'No'}</p>
                    ${items.length > 0 ? `<pre>${JSON.stringify(items[0], null, 2)}</pre>` : ''}
                `, items.length >= 0 ? 'success' : 'error');
                
            } catch (error) {
                addResult('RSS Manager Test Failed', error.message, 'error');
            }
        }

        async function testDifferentUser() {
            const username = prompt('Enter Letterboxd username to test:', 'ghosteffect');
            if (!username) return;
            
            clearResults();
            addResult('Testing Different User', `Testing RSS for user: ${username}`, 'info');
            
            try {
                const rssManager = window.letterboxdRSS;
                rssManager.init(username, true);
                rssManager.clearCache();
                
                const items = await rssManager.fetchRSSFeed();
                
                addResult(`Results for ${username}`, `
                    <p>RSS items found: ${items.length}</p>
                    <p>Profile accessible: ${items.length >= 0 ? 'Yes' : 'No'}</p>
                    ${items.length > 0 ? `
                        <p><strong>Recent activity:</strong></p>
                        <pre>${JSON.stringify(items.slice(0, 2), null, 2)}</pre>
                    ` : '<p>No recent activity or profile not accessible</p>'}
                `, items.length >= 0 ? 'success' : 'warning');
                
            } catch (error) {
                addResult(`Test Failed for ${username}`, error.message, 'error');
            }
        }

        // Load configuration on page load
        window.addEventListener('load', async () => {
            try {
                await loadUserConfig();
            } catch (error) {
                console.error('Failed to load config on startup:', error);
            }
        });
    </script>
</body>
</html>
