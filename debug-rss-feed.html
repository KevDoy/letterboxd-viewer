<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug RSS Feed for ghosteffect</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .entry { border: 1px solid #ccc; padding: 10px; margin: 10px 0; }
        .recent { background-color: #e8f5e8; }
        .old { background-color: #f5f5f5; }
        .error { background-color: #ffeaea; color: #cc0000; }
    </style>
</head>
<body>
    <h1>RSS Feed Debug for ghosteffect</h1>
    <div id="results"></div>

    <script src="rss-manager.js"></script>
    <script>
        async function debugRSSFeed() {
            const results = document.getElementById('results');
            results.innerHTML = '<p>Debugging RSS feed...</p>';

            try {
                // Initialize RSS manager
                const rssManager = new LetterboxdRSSManager();
                window.letterboxdRSS = rssManager;
                rssManager.init('ghosteffect', true);

                results.innerHTML += '<p>‚úÖ RSS Manager initialized for ghosteffect</p>';

                // Test RSS access
                const hasAccess = await rssManager.testRSSAccess('ghosteffect');
                results.innerHTML += `<p>${hasAccess ? '‚úÖ' : '‚ùå'} RSS Access: ${hasAccess}</p>';

                if (!hasAccess) {
                    results.innerHTML += '<p class="error">Cannot access RSS feed. This could be due to:</p>';
                    results.innerHTML += '<ul class="error">';
                    results.innerHTML += '<li>Username "ghosteffect" not found on Letterboxd</li>';
                    results.innerHTML += '<li>RSS feed is private</li>';
                    results.innerHTML += '<li>CORS issues</li>';
                    results.innerHTML += '</ul>';
                    return;
                }

                // Fetch raw RSS data
                results.innerHTML += '<p>üì° Fetching RSS feed data...</p>';
                const rssItems = await rssManager.fetchRSSFeed('ghosteffect');
                results.innerHTML += `<p>‚úÖ Retrieved ${rssItems.length} RSS items</p>';

                // Show the cutoff date (latest CSV entry)
                const latestCSVDate = new Date('2025-08-01'); // Your latest CSV entry
                results.innerHTML += `<p><strong>Latest CSV Entry Date:</strong> ${latestCSVDate.toDateString()}</p>';

                // Filter and show recent diary entries
                const diaryEntries = rssItems.filter(item => item.activityType === 'diary');
                results.innerHTML += `<p>üìî Found ${diaryEntries.length} diary entries in RSS</p>';

                const recentEntries = diaryEntries.filter(item => item.pubDate > latestCSVDate);
                results.innerHTML += `<p><strong>üÜï New entries since latest CSV (${latestCSVDate.toDateString()}):</strong> ${recentEntries.length}</p>';

                // Display all diary entries with dates
                results.innerHTML += '<h2>All Diary Entries from RSS:</h2>';
                
                if (diaryEntries.length === 0) {
                    results.innerHTML += '<p class="error">No diary entries found in RSS feed</p>';
                } else {
                    diaryEntries.slice(0, 10).forEach((entry, index) => {
                        const isRecent = entry.pubDate > latestCSVDate;
                        const entryClass = isRecent ? 'recent' : 'old';
                        
                        results.innerHTML += `
                            <div class="entry ${entryClass}">
                                <strong>${isRecent ? 'üÜï NEW' : 'üìÖ OLD'}</strong><br>
                                <strong>Film:</strong> ${entry.filmInfo.title || 'Unknown'}<br>
                                <strong>Date:</strong> ${entry.pubDate.toDateString()} (${entry.pubDate.toISOString()})<br>
                                <strong>Rating:</strong> ${entry.filmInfo.rating || 'No rating'} ${entry.filmInfo.rating ? '‚òÖ'.repeat(entry.filmInfo.rating) : ''}<br>
                                <strong>URL:</strong> ${entry.filmInfo.letterboxdUrl || 'No URL'}<br>
                                <strong>Raw Title:</strong> ${entry.title}
                            </div>
                        `;
                    });
                }

                // Test the specific method that should return new entries
                results.innerHTML += '<h2>Testing getDiaryEntriesSince method:</h2>';
                const newEntries = await rssManager.getDiaryEntriesSince('2025-08-01');
                results.innerHTML += `<p>üìä getDiaryEntriesSince('2025-08-01') returned: ${newEntries.length} entries</p>';

                if (newEntries.length > 0) {
                    newEntries.forEach(entry => {
                        results.innerHTML += `
                            <div class="entry recent">
                                <strong>üé¨ ${entry.Name} (${entry.Year})</strong><br>
                                <strong>Rating:</strong> ${entry.Rating} ${entry.Rating ? '‚òÖ'.repeat(parseInt(entry.Rating)) : ''}<br>
                                <strong>Watched:</strong> ${entry['Watched Date']}<br>
                                <strong>Live Data:</strong> ${entry.isLiveData}
                            </div>
                        `;
                    });
                } else {
                    results.innerHTML += '<p class="error">‚ùå No new entries found since 2025-08-01</p>';
                    results.innerHTML += '<p>This means either:</p>';
                    results.innerHTML += '<ul>';
                    results.innerHTML += '<li>You haven\'t logged any new films since August 1st</li>';
                    results.innerHTML += '<li>The RSS feed hasn\'t updated yet</li>';
                    results.innerHTML += '<li>There\'s an issue with date filtering</li>';
                    results.innerHTML += '</ul>';
                }

            } catch (error) {
                results.innerHTML += `<p class="error">‚ùå Error: ${error.message}</p>';
                console.error('Debug error:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', debugRSSFeed);
    </script>
</body>
</html>
