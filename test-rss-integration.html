<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test RSS Integration</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; color: #856404; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1>RSS Integration Test</h1>
        <p class="text-muted">Testing the enhanced RSS functionality with smart date filtering and new film addition.</p>
        
        <div class="test-section">
            <h3>Configuration Check</h3>
            <button class="btn btn-primary" onclick="testConfiguration()">Test Configuration</button>
            <div id="config-results"></div>
        </div>
        
        <div class="test-section">
            <h3>RSS Manager Test</h3>
            <button class="btn btn-primary" onclick="testRSSManager()">Test RSS Manager</button>
            <div id="rss-results"></div>
        </div>
        
        <div class="test-section">
            <h3>Data Merging Test</h3>
            <button class="btn btn-primary" onclick="testDataMerging()">Test Smart Merging</button>
            <div id="merge-results"></div>
        </div>
        
        <div class="test-section">
            <h3>Star Rating Test</h3>
            <button class="btn btn-primary" onclick="testStarRatings()">Test Star Rating Display</button>
            <div id="star-results"></div>
        </div>
    </div>

    <script src="rss-manager.js"></script>
    <script src="app.js"></script>
    <script>
        function addResult(containerId, title, content, type = 'info') {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `<strong>${title}:</strong> ${content}`;
            container.appendChild(div);
        }

        async function testConfiguration() {
            const container = document.getElementById('config-results');
            container.innerHTML = '';

            try {
                // Test user configuration
                const response = await fetch('letterboxd-export/users.json');
                const config = await response.json();
                const user = config.users[0];

                addResult('config-results', 'User Config Loaded', `
                    <br>User: ${user.displayName}
                    <br>Live Data Enabled: ${user.enableLiveData}
                    <br>Username: ${user.letterboxdUsername}
                `, 'success');

                // Test RSS manager availability
                if (window.letterboxdRSS) {
                    addResult('config-results', 'RSS Manager Available', 'RSS manager instance found', 'success');
                    
                    // Initialize RSS manager
                    const initialized = window.letterboxdRSS.init(user.letterboxdUsername, user.enableLiveData);
                    addResult('config-results', 'RSS Manager Initialized', `Initialization result: ${initialized}`, initialized ? 'success' : 'error');
                } else {
                    addResult('config-results', 'RSS Manager Missing', 'RSS manager not found in window object', 'error');
                }

            } catch (error) {
                addResult('config-results', 'Configuration Error', error.message, 'error');
            }
        }

        async function testRSSManager() {
            const container = document.getElementById('rss-results');
            container.innerHTML = '';

            if (!window.letterboxdRSS) {
                addResult('rss-results', 'RSS Manager Missing', 'Please run configuration test first', 'error');
                return;
            }

            try {
                // Clear cache for fresh test
                window.letterboxdRSS.clearCache();
                
                // Test RSS feed fetching
                addResult('rss-results', 'Fetching RSS Feed', 'Testing RSS feed access...', 'info');
                
                const rssItems = await window.letterboxdRSS.fetchRSSFeed();
                addResult('rss-results', 'RSS Feed Fetched', `Found ${rssItems.length} RSS items`, rssItems.length > 0 ? 'success' : 'warning');

                if (rssItems.length > 0) {
                    // Test diary entries
                    const diaryEntries = await window.letterboxdRSS.getRecentDiaryEntries(5);
                    addResult('rss-results', 'Diary Entries', `Found ${diaryEntries.length} diary entries`, diaryEntries.length > 0 ? 'success' : 'warning');

                    if (diaryEntries.length > 0) {
                        const sampleEntry = diaryEntries[0];
                        addResult('rss-results', 'Sample Entry', `
                            <br>Name: ${sampleEntry.Name}
                            <br>Year: ${sampleEntry.Year}
                            <br>Rating: ${sampleEntry.Rating}
                            <br>Date: ${sampleEntry['Watched Date']}
                            <br>Live Data Flag: ${sampleEntry.isLiveData}
                        `, 'info');
                    }
                }

            } catch (error) {
                addResult('rss-results', 'RSS Manager Error', error.message, 'error');
            }
        }

        async function testDataMerging() {
            const container = document.getElementById('merge-results');
            container.innerHTML = '';

            try {
                // Load sample CSV data
                const response = await fetch('letterboxd-export/SampleUser/diary.csv');
                const csvText = await response.text();
                const lines = csvText.split('\n').filter(line => line.trim());
                const headers = lines[0].split(',');
                
                const csvData = lines.slice(1).map(line => {
                    const values = line.split(',');
                    const entry = {};
                    headers.forEach((header, index) => {
                        entry[header.trim()] = values[index]?.trim() || '';
                    });
                    return entry;
                });

                addResult('merge-results', 'CSV Data Loaded', `Loaded ${csvData.length} CSV entries`, 'success');

                if (window.letterboxdRSS && window.letterboxdRSS.isLiveDataAvailable()) {
                    // Test merging with diary data
                    const mergedDiary = await window.letterboxdRSS.mergeWithDiaryData(csvData);
                    const newDiaryEntries = mergedDiary.length - csvData.length;
                    
                    addResult('merge-results', 'Diary Merge Result', `
                        <br>Original CSV entries: ${csvData.length}
                        <br>Merged diary entries: ${mergedDiary.length}
                        <br>New entries added: ${newDiaryEntries}
                    `, newDiaryEntries > 0 ? 'success' : 'info');

                    // Test watched data merging
                    const watchedResponse = await fetch('letterboxd-export/SampleUser/watched.csv');
                    const watchedText = await watchedResponse.text();
                    const watchedLines = watchedText.split('\n').filter(line => line.trim());
                    const watchedHeaders = watchedLines[0].split(',');
                    
                    const watchedData = watchedLines.slice(1).map(line => {
                        const values = line.split(',');
                        const entry = {};
                        watchedHeaders.forEach((header, index) => {
                            entry[header.trim()] = values[index]?.trim() || '';
                        });
                        return entry;
                    });

                    const mergedWatched = await window.letterboxdRSS.mergeWithWatchedData(watchedData, diaryData);
                    const newWatchedEntries = mergedWatched.length - watchedData.length;

                    addResult('merge-results', 'Watched Merge Result', `
                        <br>Original watched entries: ${watchedData.length}
                        <br>Merged watched entries: ${mergedWatched.length}
                        <br>New films added: ${newWatchedEntries}
                    `, newWatchedEntries > 0 ? 'success' : 'info');

                } else {
                    addResult('merge-results', 'RSS Not Available', 'RSS manager not available for merging test', 'warning');
                }

            } catch (error) {
                addResult('merge-results', 'Merge Test Error', error.message, 'error');
            }
        }

        async function testStarRatings() {
            const container = document.getElementById('star-results');
            container.innerHTML = '';

            // Create a test viewer instance
            const testViewer = new LetterboxdViewer();

            // Test different rating values
            const testRatings = [5, 4.5, 4, 3.5, 3, 2.5, 2, 1.5, 1, 0.5, 0, '', null, undefined];
            
            testRatings.forEach(rating => {
                const formatted = testViewer.formatStarRating(rating);
                addResult('star-results', `Rating ${rating}`, `"${formatted}"`, 'info');
            });

            // Test RSS rating extraction
            if (window.letterboxdRSS && window.letterboxdRSS.isLiveDataAvailable()) {
                try {
                    const diaryEntries = await window.letterboxdRSS.getRecentDiaryEntries(3);
                    if (diaryEntries.length > 0) {
                        diaryEntries.forEach((entry, index) => {
                            const formatted = testViewer.formatStarRating(entry.Rating);
                            addResult('star-results', `RSS Entry ${index + 1}`, `
                                <br>Film: ${entry.Name}
                                <br>Raw Rating: "${entry.Rating}"
                                <br>Formatted: "${formatted}"
                            `, 'info');
                        });
                    } else {
                        addResult('star-results', 'No RSS Entries', 'No RSS diary entries to test', 'warning');
                    }
                } catch (error) {
                    addResult('star-results', 'RSS Rating Error', error.message, 'error');
                }
            }
        }

        // Auto-run configuration test on load
        window.addEventListener('load', () => {
            setTimeout(testConfiguration, 500);
        });
    </script>
</body>
</html>
