<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug RSS Live Data</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .debug-section { border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 1rem; margin: 1rem 0; }
        .status-pass { color: #198754; }
        .status-fail { color: #dc3545; }
        .status-warning { color: #fd7e14; }
        pre { font-size: 0.8rem; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>Debug RSS Live Data Issue</h1>
        
        <div class="debug-section">
            <h3>1. RSS Connectivity Test</h3>
            <button id="testRSS" class="btn btn-primary">Test RSS Access</button>
            <div id="rss-results" class="mt-2"></div>
        </div>
        
        <div class="debug-section">
            <h3>2. Recent RSS Entries</h3>
            <button id="fetchEntries" class="btn btn-primary">Fetch Recent Entries</button>
            <div id="entries-results" class="mt-2"></div>
        </div>
        
        <div class="debug-section">
            <h3>3. CSV Data Analysis</h3>
            <button id="analyzeCSV" class="btn btn-primary">Analyze Latest CSV Date</button>
            <div id="csv-results" class="mt-2"></div>
        </div>
        
        <div class="debug-section">
            <h3>4. Merge Simulation</h3>
            <button id="simulateMerge" class="btn btn-primary">Simulate Data Merge</button>
            <div id="merge-results" class="mt-2"></div>
        </div>
    </div>

    <script src="rss-manager.js"></script>
    <script src="app.js"></script>
    <script>
        let app;
        let rssManager;
        
        async function initializeDebug() {
            // Initialize RSS manager
            rssManager = new LetterboxdRSSManager();
            window.letterboxdRSS = rssManager;
            rssManager.init('ghosteffect', true);
            
            // Initialize app with mock data
            app = new LetterboxdViewer();
            app.currentUser = {
                id: 'Kev',
                letterboxdUsername: 'ghosteffect',
                enableLiveData: true
            };
            
            // Load CSV data (simulate)
            try {
                const response = await fetch('./letterboxd-export/Kev/diary.csv');
                const csvText = await response.text();
                const lines = csvText.split('\n');
                const headers = lines[0].split(',');
                
                app.data = { diary: [], watched: [] };
                
                for (let i = 1; i < lines.length && i < 20; i++) { // Just load first 20 for testing
                    if (lines[i].trim()) {
                        const values = lines[i].split(',');
                        const entry = {};
                        headers.forEach((header, index) => {
                            entry[header.replace(/"/g, '')] = values[index] ? values[index].replace(/"/g, '') : '';
                        });
                        app.data.diary.push(entry);
                    }
                }
                
                console.log('Loaded', app.data.diary.length, 'CSV entries');
            } catch (error) {
                console.error('Could not load CSV data:', error);
                app.data = { diary: [], watched: [] };
            }
            
            window.viewer = app;
        }
        
        document.getElementById('testRSS').addEventListener('click', async () => {
            const resultsDiv = document.getElementById('rss-results');
            resultsDiv.innerHTML = '<p>Testing RSS access...</p>';
            
            try {
                const hasAccess = await rssManager.testRSSAccess('ghosteffect');
                resultsDiv.innerHTML = `
                    <p class="${hasAccess ? 'status-pass' : 'status-fail'}">
                        ${hasAccess ? '✅' : '❌'} RSS Access: ${hasAccess}
                    </p>
                `;
                
                if (hasAccess) {
                    const rawFeed = await rssManager.fetchRSSFeed('ghosteffect');
                    resultsDiv.innerHTML += `
                        <p class="status-pass">✅ Raw RSS feed contains ${rawFeed.length} items</p>
                        <details>
                            <summary>First RSS item</summary>
                            <pre>${JSON.stringify(rawFeed[0], null, 2)}</pre>
                        </details>
                    `;
                }
            } catch (error) {
                resultsDiv.innerHTML += `<p class="status-fail">❌ Error: ${error.message}</p>`;
            }
        });
        
        document.getElementById('fetchEntries').addEventListener('click', async () => {
            const resultsDiv = document.getElementById('entries-results');
            resultsDiv.innerHTML = '<p>Fetching recent entries...</p>';
            
            try {
                const entries = await rssManager.getRecentDiaryEntries(10);
                resultsDiv.innerHTML = `
                    <p class="status-pass">✅ Found ${entries.length} diary entries</p>
                `;
                
                if (entries.length > 0) {
                    resultsDiv.innerHTML += '<h5>Recent Entries:</h5>';
                    entries.slice(0, 3).forEach((entry, index) => {
                        resultsDiv.innerHTML += `
                            <div class="border p-2 mb-2">
                                <strong>${entry.Name} (${entry.Year})</strong><br>
                                Watched: ${entry['Watched Date']}<br>
                                Rating: ${entry.Rating} ${entry.Rating ? '★'.repeat(parseInt(entry.Rating)) : ''}<br>
                                Live Data: ${entry.isLiveData}<br>
                                URL: ${entry['Letterboxd URI']}
                            </div>
                        `;
                    });
                    
                    resultsDiv.innerHTML += `
                        <details>
                            <summary>All entries (JSON)</summary>
                            <pre>${JSON.stringify(entries, null, 2)}</pre>
                        </details>
                    `;
                } else {
                    resultsDiv.innerHTML += '<p class="status-warning">⚠️ No diary entries found in RSS feed</p>';
                }
            } catch (error) {
                resultsDiv.innerHTML += `<p class="status-fail">❌ Error: ${error.message}</p>`;
            }
        });
        
        document.getElementById('analyzeCSV').addEventListener('click', () => {
            const resultsDiv = document.getElementById('csv-results');
            
            if (app.data.diary.length === 0) {
                resultsDiv.innerHTML = '<p class="status-warning">⚠️ No CSV data loaded</p>';
                return;
            }
            
            // Find latest date
            const dates = app.data.diary
                .map(entry => entry.Date || entry.WatchedDate || entry['Watched Date'])
                .filter(date => date)
                .map(date => new Date(date))
                .filter(date => !isNaN(date));
            
            if (dates.length === 0) {
                resultsDiv.innerHTML = '<p class="status-warning">⚠️ No valid dates found in CSV data</p>';
                return;
            }
            
            const latestDate = new Date(Math.max(...dates));
            const oldestDate = new Date(Math.min(...dates));
            
            resultsDiv.innerHTML = `
                <p class="status-pass">✅ CSV Data Analysis:</p>
                <ul>
                    <li>Total entries: ${app.data.diary.length}</li>
                    <li>Latest entry: ${latestDate.toISOString().split('T')[0]}</li>
                    <li>Oldest entry: ${oldestDate.toISOString().split('T')[0]}</li>
                    <li>Days since latest: ${Math.floor((new Date() - latestDate) / (1000 * 60 * 60 * 24))}</li>
                </ul>
                <details>
                    <summary>Latest entries</summary>
                    <pre>${JSON.stringify(app.data.diary.slice(0, 3), null, 2)}</pre>
                </details>
            `;
        });
        
        document.getElementById('simulateMerge').addEventListener('click', async () => {
            const resultsDiv = document.getElementById('merge-results');
            resultsDiv.innerHTML = '<p>Simulating merge...</p>';
            
            try {
                // Get RSS entries
                const rssEntries = await rssManager.getRecentDiaryEntries(10);
                
                // Simulate the merge logic from the dashboard
                let mergedData = app.mergeLiveDataWithCSV(app.data.diary, rssEntries, {
                    maxLiveEntries: 10,
                    onlyNewerThanLatest: true,
                    strictDuplicateCheck: true
                });
                
                const newEntries = mergedData.length - app.data.diary.length;
                
                resultsDiv.innerHTML = `
                    <p class="status-pass">✅ Merge Simulation Complete:</p>
                    <ul>
                        <li>Original CSV entries: ${app.data.diary.length}</li>
                        <li>RSS entries available: ${rssEntries.length}</li>
                        <li>After merge: ${mergedData.length} entries</li>
                        <li>New entries added: ${newEntries}</li>
                    </ul>
                `;
                
                if (newEntries === 0) {
                    resultsDiv.innerHTML += `
                        <div class="alert alert-warning">
                            <strong>🔍 No new entries were added!</strong><br>
                            This could be because:
                            <ul>
                                <li>RSS entries are older than your latest CSV export</li>
                                <li>RSS entries are duplicates of existing CSV entries</li>
                                <li>No recent activity in your Letterboxd RSS feed</li>
                            </ul>
                        </div>
                    `;
                } else {
                    resultsDiv.innerHTML += '<h5>New entries that would be added:</h5>';
                    const newItems = mergedData.slice(0, newEntries);
                    newItems.forEach(entry => {
                        resultsDiv.innerHTML += `
                            <div class="border p-2 mb-2 bg-light">
                                <strong>${entry.Name} (${entry.Year})</strong><br>
                                Watched: ${entry['Watched Date'] || entry.Date}<br>
                                Rating: ${entry.Rating} ${entry.Rating ? '★'.repeat(parseInt(entry.Rating)) : ''}<br>
                                From RSS: ${entry.isLiveData || entry._isFromRSS}
                            </div>
                        `;
                    });
                }
                
            } catch (error) {
                resultsDiv.innerHTML += `<p class="status-fail">❌ Error: ${error.message}</p>`;
            }
        });
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializeDebug);
    </script>
</body>
</html>
