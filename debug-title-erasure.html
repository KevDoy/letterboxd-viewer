<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Title Erasure Issue</title>
</head>
<body>
    <h1>Debug Title Erasure Issue - Jonah's Twisters</h1>
    <div id="debug-output"></div>
    <div id="console-log"></div>

    <script src="rss-manager.js"></script>
    <script>
        // Capture console logs
        const originalLog = console.log;
        const logDiv = document.getElementById('console-log');
        console.log = function(...args) {
            originalLog.apply(console, args);
            logDiv.innerHTML += '<div>' + args.join(' ') + '</div>';
        };

        async function debugTitleErasure() {
            const debugOutput = document.getElementById('debug-output');
            
            try {
                // Initialize RSS manager
                const rssManager = new LetterboxdRSSManager();
                await rssManager.init();
                
                // Set current user to Jonah
                rssManager.setCurrentUser = function(username) {
                    this.currentUsername = username;
                    this.isEnabled = true;
                };
                rssManager.setCurrentUser('jonahathey');
                
                debugOutput.innerHTML += '<h2>Testing Title Extraction for Potential Duplicates</h2>';
                
                // Simulate RSS entries for Twisters (both new and potentially duplicate scenarios)
                const testRSSItems = [
                    {
                        title: "jonahathey Twisters, 2024 - ★★★",
                        link: "https://letterboxd.com/film/twisters-2024/",
                        description: "",
                        pubDate: new Date('2025-08-14'),
                        activityType: 'diary',
                        filmInfo: null // Will be set by extractFilmInfo
                    },
                    {
                        title: "jonahathey Twisters, 2024 - ★★★★",
                        link: "https://letterboxd.com/film/twisters-2024/",
                        description: "",
                        pubDate: new Date('2025-08-13'),
                        activityType: 'diary',
                        filmInfo: null // Will be set by extractFilmInfo
                    }
                ];
                
                debugOutput.innerHTML += '<h3>Test RSS Items:</h3>';
                testRSSItems.forEach((item, index) => {
                    debugOutput.innerHTML += `<p><strong>Item ${index + 1}:</strong> ${item.title}</p>`;
                });
                
                // Test film info extraction for each item
                debugOutput.innerHTML += '<h3>Film Info Extraction Results:</h3>';
                testRSSItems.forEach((item, index) => {
                    console.log(`=== Testing item ${index + 1}: ${item.title} ===`);
                    
                    // Extract film info
                    const filmInfo = rssManager.extractFilmInfo(item.title, item.link, item.description);
                    item.filmInfo = filmInfo;
                    
                    console.log('Extraction result:', filmInfo);
                    
                    const titleStatus = filmInfo.title ? 'SUCCESS' : 'FAILED - NULL TITLE';
                    const bgColor = filmInfo.title ? '#e8f5e8' : '#ffe8e8';
                    
                    debugOutput.innerHTML += `
                        <div style="background: ${bgColor}; margin: 10px 0; padding: 10px; border-left: 3px solid ${filmInfo.title ? '#4CAF50' : '#f44336'};">
                            <p><strong>Item ${index + 1} - ${titleStatus}</strong></p>
                            <p><strong>Original:</strong> ${item.title}</p>
                            <p><strong>Extracted Title:</strong> ${filmInfo.title || 'NULL'}</p>
                            <p><strong>Year:</strong> ${filmInfo.year || 'NULL'}</p>
                            <p><strong>Rating:</strong> ${filmInfo.rating || 'NULL'}</p>
                            <p><strong>Link:</strong> ${filmInfo.letterboxdUrl || 'NULL'}</p>
                        </div>
                    `;
                });
                
                // Test diary format conversion
                debugOutput.innerHTML += '<h3>Diary Format Conversion:</h3>';
                testRSSItems.forEach((item, index) => {
                    console.log(`=== Converting item ${index + 1} to diary format ===`);
                    
                    const diaryEntry = rssManager.convertRSSItemToDiaryFormat(item);
                    
                    console.log('Diary conversion result:', diaryEntry);
                    
                    if (diaryEntry) {
                        debugOutput.innerHTML += `
                            <div style="background: #e8f5e8; margin: 10px 0; padding: 10px; border-left: 3px solid #4CAF50;">
                                <p><strong>Item ${index + 1} - CONVERTED SUCCESSFULLY</strong></p>
                                <p><strong>Name:</strong> ${diaryEntry['Name']}</p>
                                <p><strong>Year:</strong> ${diaryEntry['Year']}</p>
                                <p><strong>Rating:</strong> ${diaryEntry['Rating']}</p>
                                <p><strong>Date:</strong> ${diaryEntry['Date']}</p>
                            </div>
                        `;
                    } else {
                        debugOutput.innerHTML += `
                            <div style="background: #ffe8e8; margin: 10px 0; padding: 10px; border-left: 3px solid #f44336;">
                                <p><strong>Item ${index + 1} - CONVERSION FAILED (NULL RETURNED)</strong></p>
                                <p>This indicates the title was rejected during validation</p>
                            </div>
                        `;
                    }
                });
                
                // Test with mock existing diary data to see if duplicates are handled properly
                debugOutput.innerHTML += '<h3>Testing with Existing Diary Data (Simulate Duplicate Check):</h3>';
                
                const mockExistingDiary = [
                    {
                        'Date': '2025-08-10',
                        'Name': 'Twisters',
                        'Year': '2024',
                        'Rating': '2',
                        'Letterboxd URI': 'https://letterboxd.com/film/twisters-2024/',
                        'Watched Date': '2025-08-10'
                    }
                ];
                
                debugOutput.innerHTML += '<p><strong>Mock existing diary entry:</strong> Twisters (2024) watched on 2025-08-10 with 2-star rating</p>';
                
                // Simulate the date filtering logic
                const latestDate = new Date('2025-08-10'); // Last entry date
                const testNewDate = new Date('2025-08-14'); // New RSS entry date
                
                const isNewer = rssManager.formatDateForCSV(testNewDate) > rssManager.formatDateForCSV(latestDate);
                
                debugOutput.innerHTML += `
                    <div style="background: ${isNewer ? '#e8f5e8' : '#ffe8e8'}; margin: 10px 0; padding: 10px; border-left: 3px solid ${isNewer ? '#4CAF50' : '#f44336'};">
                        <p><strong>Date Comparison Test</strong></p>
                        <p>Latest existing date: ${rssManager.formatDateForCSV(latestDate)}</p>
                        <p>New RSS entry date: ${rssManager.formatDateForCSV(testNewDate)}</p>
                        <p>Is newer: ${isNewer}</p>
                        <p><strong>Result:</strong> ${isNewer ? 'NEW ENTRY SHOULD BE ADDED' : 'NEW ENTRY SHOULD BE FILTERED OUT'}</p>
                    </div>
                `;
                
                if (isNewer) {
                    debugOutput.innerHTML += `
                        <div style="background: #e8f5e8; color: #2e7d32; padding: 10px; margin: 10px 0; border-radius: 5px;">
                            <strong>✅ CONCLUSION:</strong> Since the new Twisters entry has a newer date (2025-08-14 vs 2025-08-10), 
                            it should be added as a legitimate re-watch, not filtered out as a duplicate. 
                            The date-based filtering should handle this correctly without needing title-based duplicate detection.
                        </div>
                    `;
                } else {
                    debugOutput.innerHTML += `
                        <div style="background: #ffe8e8; color: #d32f2f; padding: 10px; margin: 10px 0; border-radius: 5px;">
                            <strong>❌ ISSUE:</strong> The date filtering logic would prevent this legitimate re-watch from being added.
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Test failed:', error);
                debugOutput.innerHTML += `<div style="background: #f44336; color: white; padding: 10px; margin: 10px 0; border-radius: 5px;">
                    <strong>ERROR:</strong> ${error.message}
                </div>`;
            }
        }
        
        // Run test when page loads
        debugTitleErasure().catch(console.error);
    </script>
</body>
</html>
